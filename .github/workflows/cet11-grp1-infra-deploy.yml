name: cet11-grp1-infra-deploy

on:
  push:
    branches: [ main ]
    paths:
      - "**/*.tf"
      - "lambda/**"
      - ".github/workflows/cet11-grp1-infra-deploy.yml"

  pull_request:
    branches: [ main ]
    paths:
      - "**/*.tf"
      - "lambda/**"

jobs:
  ###############################################
  # 1. LINT + SECURITY CHECKS
  ###############################################
  terraform-checks:
    name: Terraform Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.9.0"

      - name: Terraform fmt
        run: terraform fmt -recursive

      - name: Terraform init
        run: terraform init

      - name: Terraform validate
        run: terraform validate

      - name: Install tflint
        run: |
          curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash

      - name: Run tflint
        run: tflint --no-color

      - name: Checkov security scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .

  ###############################################
  # 2. PACKAGE LAMBDA ZIP
  ###############################################
  package-lambda:
    name: Package cet11-grp1 Lambda
    runs-on: ubuntu-latest
    needs: terraform-checks

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Zip Lambda code
        run: |
          cd lambda
          zip -r ../lambda.zip .
          cd ..

      - name: Upload ZIP artifact
        uses: actions/upload-artifact@v4
        with:
          name: lambda-zip
          path: lambda.zip

  ###############################################
  # 3. TERRAFORM PLAN (PR ONLY)
  ###############################################
  terraform-plan:
    name: Terraform Plan (PR)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: [terraform-checks, package-lambda]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Lambda ZIP
        uses: actions/download-artifact@v4
        with:
          name: lambda-zip

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform init
        run: terraform init

      - name: Terraform plan
        run: terraform plan -no-color

  ###############################################
  # 4. TERRAFORM APPLY (MAIN BRANCH DEPLOY)
  ###############################################
  terraform-apply:
    name: Terraform Apply (Deploy to AWS)
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [terraform-checks, package-lambda]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Lambda ZIP
        uses: actions/download-artifact@v4
        with:
          name: lambda-zip

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform init
        run: terraform init

      - name: Terraform apply
        run: terraform apply -auto-approve

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: us-east-1
